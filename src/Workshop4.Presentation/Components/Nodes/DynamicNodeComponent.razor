@using System.Diagnostics.CodeAnalysis
@using Phazor.Components.Models
@using Workshop4.Application.Pipelines.Nodes
@using Workshop4.Presentation.Components.NodeActions
@using Workshop4.Presentation.Visitors
@namespace Workshop4.Presentation.Components.Nodes

@{
    var visitor = new DynamicNodeVisitor(OnGroupOpened, HighlightedNode);
    Node.Accept(visitor);

    bool isExecuting = visitor.IsCurrentNode;
    string cssClass = isExecuting ? "pa-0 node-executing" : "pa-0";
}

<PhazorGrid
    Dimension="PhazorGridDimension.Rows"
    DisableAnimation="true"
    Class="@cssClass">

    <PhazorGridItem MajorIndex="1" MinorIndex="1" MajorSpan="2" Style="height: 100%">
        <MudCard Elevation="2" Style="height: 100%; background: #f1f1f1" Class="node-card-wrapper"/>
    </PhazorGridItem>

    <PhazorGridItem MajorIndex="1" MinorIndex="1">
        <PhazorHStack
            Horizontal="HorizontalDistribution.Left"
            Vertical="VerticalAlignment.Center"
            Gap="10px"
            Class="pa-3">

            <RemoveNodeActionComponent
                OnRemoveNodeClicked="@(() => OnNodeRemoved.InvokeAsync(Node))"/>

            @foreach (RenderFragment action in visitor.Actions)
            {
                @action
            }

        </PhazorHStack>
    </PhazorGridItem>

    <PhazorGridItem MajorIndex="2" MinorIndex="1">
        @if (visitor.NodeComponent is not null)
        {
            @visitor.NodeComponent
        }
        else
        {
            <MudAlert Severity="Severity.Warning" Variant="Variant.Outlined">
                Unknown node type: @Node.GetType().Name
            </MudAlert>
        }
    </PhazorGridItem>

</PhazorGrid>

@code {

    [Parameter]
    public bool Disabled { get; set; }

    [NotNull]
    [Parameter]
    [EditorRequired]
    public IPipelineNode? Node { get; set; }

    [Parameter]
    public IPipelineNode? HighlightedNode { get; set; }

    [Parameter]
    public EventCallback<IPipelineNode> OnNodeRemoved { get; set; }

    [Parameter]
    public EventCallback<GroupNode> OnGroupOpened { get; set; }

}
@page "/"
@using Workshop4.Presentation.Services
@using Workshop4.Presentation.Components.Pipeline
@using Workshop4.Application.Pipelines.Nodes
@using Workshop4.Application.Json.Factories
@using Workshop4.Application.Json.Models
@using Workshop4.Application.Pipelines.Models
@using System.Linq
@using Phazor.Components.Models
@using Workshop4.Presentation.Execution
@using HorizontalAlignment = Phazor.Components.Models.HorizontalAlignment
@implements Workshop4.Application.Pipelines.Presentation.IPipelinePresentationManager

<PageTitle>Workshop 4</PageTitle>

<PhazorHStack
    Horizontal="HorizontalDistribution.Between"
    Vertical="VerticalAlignment.Stretch"
    Class="pa-4"
    Gap="15px">

    <MudCard Style="flex-basis: 20%" Elevation="3">
        <MudCardContent>
            <PhazorVStack
                Horizontal="HorizontalAlignment.Stretch"
                Gap="10px">

                <PipelineControlsComponent
                    ExecutionStrategy="_executionStrategy"
                    OnExecuteClicked="StartExecutionAsync"/>

                <MudTextField
                    @bind-Value="@AppState.Instance.InputJson"
                    FullWidth="true"
                    Lines="14"
                    Label="JSON"
                    Variant="Variant.Outlined"
                    Disabled="@AppState.Instance.IsExecuting"
                    Class="mud-input-height-full"
                    Style="flex-grow: 1"/>

            </PhazorVStack>
        </MudCardContent>
    </MudCard>

    <WorkspaceComponent CurrentExecutingNode="_currentExecutingNode"/>
    <OutputComponent ExecutionFrames="_executionFrameStack"/>

</PhazorHStack>

@code {
    private readonly IJsonDocumentFactory _jsonFactory = new JsonDocumentFactory();
    private readonly Stack<ExecutionFrame> _executionFrameStack = [];

    private IExecutionStrategy? _executionStrategy;
    private IPipelineNode? _currentExecutingNode;

    protected override void OnInitialized()
    {
        AppState.Instance.Initialize(MockFactory.CreatePipeline());
    }

    private async Task StartExecutionAsync(IExecutionStrategyFactory factory)
    {
        if (AppState.Instance.IsExecuting)
            return;

        JsonDocument workingDocument = _jsonFactory.CreateDocument(AppState.Instance.InputJson);
        _executionStrategy = factory.Create(workingDocument, new ExecutionContext(this));

        await _executionStrategy.StartAsync();
    }

    public async Task OnExecutingNodeChangedAsync(IPipelineNode? node)
    {
        _currentExecutingNode = node;

        if (AppState.Instance.IsExecuting && node is GroupNode group)
        {
            AppState.Instance.NavigateTo(group);
        }

        StateHasChanged();
    }

    public Task OnStateChanged()
    {
        return InvokeAsync(StateHasChanged);
    }

    public void UpdateExecutionFrames(Stack<ExecutionFrame> frames)
    {
        _executionFrameStack.Clear();

        foreach (ExecutionFrame executionFrame in frames.Reverse())
        {
            _executionFrameStack.Push(executionFrame);
        }

        StateHasChanged();
    }

}
